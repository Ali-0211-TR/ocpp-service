<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texnouz OCPP â€” ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</title>
    <style>
        :root {
            --bg: #1e1e2e;
            --surface: #313244;
            --overlay: #45475a;
            --text: #cdd6f4;
            --subtext: #a6adc8;
            --green: #a6e3a1;
            --red: #f38ba8;
            --blue: #89b4fa;
            --yellow: #f9e2af;
            --accent: #cba6f7;
            --border: #585b70;
            --input-bg: #1e1e2e;
            --radius: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            user-select: none;
        }

        .container {
            max-width: 560px;
            margin: 0 auto;
            padding: 20px 24px;
        }

        h1 {
            font-size: 1.3em;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* â”€â”€ Status Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface);
            border-radius: var(--radius);
            padding: 10px 16px;
            margin-bottom: 14px;
            border: 1px solid var(--border);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--red);
            animation: pulse 2s infinite;
        }
        .status-dot.running { background: var(--green); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .btn-group { display: flex; gap: 5px; }

        /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        button {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.82em;
            transition: all 0.15s;
        }
        button:hover { background: var(--overlay); }
        button:active { transform: scale(0.97); }
        button:disabled { opacity: 0.35; cursor: not-allowed; }
        button.primary {
            background: var(--accent);
            color: var(--bg);
            border-color: var(--accent);
            font-weight: 600;
        }
        button.primary:hover { opacity: 0.85; }

        /* â”€â”€ Collapsible Sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        details {
            background: var(--surface);
            border-radius: var(--radius);
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }
        details[open] { border-color: var(--accent); }

        summary {
            padding: 10px 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.92em;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        summary::-webkit-details-marker { display: none; }
        summary::before {
            content: 'â–¸';
            font-size: 0.85em;
            transition: transform 0.2s;
            color: var(--subtext);
        }
        details[open] summary::before { transform: rotate(90deg); }

        .section-body { padding: 0 16px 14px; }

        /* â”€â”€ Form Fields â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .field { margin-bottom: 10px; }
        .field label {
            display: block;
            font-size: 0.8em;
            color: var(--subtext);
            margin-bottom: 3px;
        }
        .field input, .field select {
            width: 100%;
            padding: 7px 10px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.88em;
            font-family: inherit;
        }
        .field input:focus, .field select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .field-row { display: flex; gap: 10px; }
        .field-row .field { flex: 1; }

        .conn-url {
            font-size: 0.78em;
            color: var(--subtext);
            margin-top: 6px;
            word-break: break-all;
            font-family: monospace;
        }

        /* â”€â”€ Footer Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .actions {
            display: flex;
            gap: 8px;
            justify-content: space-between;
            align-items: center;
            margin-top: 14px;
            padding-top: 14px;
            border-top: 1px solid var(--border);
        }
        .actions-right { display: flex; gap: 8px; }

        .config-path {
            font-size: 0.72em;
            color: var(--subtext);
            margin-top: 10px;
            font-family: monospace;
            opacity: 0.7;
        }

        /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--green);
            color: var(--bg);
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85em;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            pointer-events: none;
        }
        .toast.show { opacity: 1; }
        .toast.error { background: var(--red); }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Texnouz OCPP</h1>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="statusDot"></div>
                <span id="statusText">ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ°...</span>
            </div>
            <div class="btn-group">
                <button id="btnStart" onclick="serverStart()" disabled title="Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ">â–¶ï¸</button>
                <button id="btnStop" onclick="serverStop()" disabled title="ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ">â¹</button>
                <button id="btnRestart" onclick="serverRestart()" disabled title="ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ">ğŸ”„</button>
            </div>
        </div>

        <!-- Server Settings -->
        <details open>
            <summary>ğŸŒ Ğ¡ĞµÑ€Ğ²ĞµÑ€</summary>
            <div class="section-body">
                <div class="field-row">
                    <div class="field">
                        <label>API Ñ…Ğ¾ÑÑ‚</label>
                        <input id="api_host" type="text">
                    </div>
                    <div class="field">
                        <label>API Ğ¿Ğ¾Ñ€Ñ‚</label>
                        <input id="api_port" type="number" min="1" max="65535">
                    </div>
                </div>
                <div class="field-row">
                    <div class="field">
                        <label>WebSocket Ñ…Ğ¾ÑÑ‚</label>
                        <input id="ws_host" type="text">
                    </div>
                    <div class="field">
                        <label>WebSocket Ğ¿Ğ¾Ñ€Ñ‚</label>
                        <input id="ws_port" type="number" min="1" max="65535">
                    </div>
                </div>
                <div class="field-row">
                    <div class="field">
                        <label>Heartbeat (ÑĞµĞº)</label>
                        <input id="heartbeat_interval" type="number" min="1">
                    </div>
                    <div class="field">
                        <label>Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ (ÑĞµĞº)</label>
                        <input id="shutdown_timeout" type="number" min="1">
                    </div>
                </div>
            </div>
        </details>

        <!-- Database Settings -->
        <details>
            <summary>ğŸ“¦ Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</summary>
            <div class="section-body">
                <div class="field">
                    <label>Ğ”Ñ€Ğ°Ğ¹Ğ²ĞµÑ€</label>
                    <select id="db_driver" onchange="toggleDbFields()">
                        <option value="sqlite">SQLite</option>
                        <option value="postgres">PostgreSQL</option>
                    </select>
                </div>
                <div id="sqlite_fields">
                    <div class="field">
                        <label>ĞŸÑƒÑ‚ÑŒ Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ</label>
                        <input id="sqlite_path" type="text">
                    </div>
                </div>
                <div id="postgres_fields" style="display:none">
                    <div class="field-row">
                        <div class="field">
                            <label>Ğ¥Ğ¾ÑÑ‚</label>
                            <input id="pg_host" type="text">
                        </div>
                        <div class="field">
                            <label>ĞŸĞ¾Ñ€Ñ‚</label>
                            <input id="pg_port" type="number">
                        </div>
                    </div>
                    <div class="field-row">
                        <div class="field">
                            <label>ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ</label>
                            <input id="pg_username" type="text">
                        </div>
                        <div class="field">
                            <label>ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</label>
                            <input id="pg_password" type="password">
                        </div>
                    </div>
                    <div class="field">
                        <label>Ğ˜Ğ¼Ñ Ğ±Ğ°Ğ·Ñ‹</label>
                        <input id="pg_database" type="text">
                    </div>
                </div>
                <div class="conn-url" id="connUrl"></div>
            </div>
        </details>

        <!-- Security Settings -->
        <details>
            <summary>ğŸ” Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ</summary>
            <div class="section-body">
                <div class="field">
                    <label>JWT Secret</label>
                    <input id="jwt_secret" type="password">
                </div>
                <div class="field">
                    <label>JWT Expiry (Ñ‡Ğ°ÑĞ¾Ğ²)</label>
                    <input id="jwt_expiration_hours" type="number" min="1">
                </div>
            </div>
        </details>

        <!-- Admin Settings -->
        <details>
            <summary>ğŸ‘¤ ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€ (Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº)</summary>
            <div class="section-body">
                <div class="field">
                    <label>Ğ˜Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ</label>
                    <input id="admin_username" type="text">
                </div>
                <div class="field">
                    <label>Email</label>
                    <input id="admin_email" type="email">
                </div>
                <div class="field">
                    <label>ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</label>
                    <input id="admin_password" type="password">
                </div>
            </div>
        </details>

        <!-- Logging Settings -->
        <details>
            <summary>ğŸ“‹ Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ</summary>
            <div class="section-body">
                <div class="field">
                    <label>Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ</label>
                    <select id="log_level">
                        <option value="error">error</option>
                        <option value="warn">warn</option>
                        <option value="info">info</option>
                        <option value="debug">debug</option>
                        <option value="trace">trace</option>
                    </select>
                </div>
            </div>
        </details>

        <!-- Actions -->
        <div class="actions">
            <button onclick="resetConfig()">ğŸ”„ Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ</button>
            <div class="actions-right">
                <button class="primary" onclick="saveConfig()">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
                <button class="primary" onclick="saveAndRestart()" style="background:#a6e3a1">ğŸ’¾ğŸ”„ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ</button>
            </div>
        </div>

        <div class="config-path" id="configPath"></div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const { invoke } = window.__TAURI__.core;

        // â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => t.className = 'toast', 2500);
        }

        // â”€â”€ Status polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function updateStatus() {
            try {
                const running = await invoke('server_status');
                const dot = document.getElementById('statusDot');
                const text = document.getElementById('statusText');
                dot.className = 'status-dot' + (running ? ' running' : '');
                text.textContent = running ? 'Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚' : 'Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½';
                document.getElementById('btnStart').disabled = running;
                document.getElementById('btnStop').disabled = !running;
                document.getElementById('btnRestart').disabled = !running;
            } catch (e) { /* ignore */ }
        }
        setInterval(updateStatus, 2000);

        // â”€â”€ Server controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function serverStart() {
            try {
                await invoke('server_start');
                showToast('âœ… Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½');
            } catch (e) { showToast('âŒ ' + e, true); }
            setTimeout(updateStatus, 500);
        }

        async function serverStop() {
            try {
                await invoke('server_stop');
                showToast('â¹ Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½');
            } catch (e) { showToast('âŒ ' + e, true); }
            setTimeout(updateStatus, 500);
        }

        async function serverRestart() {
            try {
                await invoke('server_restart');
                showToast('ğŸ”„ Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½');
            } catch (e) { showToast('âŒ ' + e, true); }
            setTimeout(updateStatus, 500);
        }

        // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function loadConfig() {
            try {
                const c = await invoke('get_config');
                populateForm(c);

                const path = await invoke('get_config_path');
                document.getElementById('configPath').textContent = 'ğŸ“„ ' + path;
            } catch (e) {
                showToast('âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: ' + e, true);
            }
        }

        function populateForm(c) {
            // Server
            document.getElementById('api_host').value = c.server.api_host;
            document.getElementById('api_port').value = c.server.api_port;
            document.getElementById('ws_host').value = c.server.ws_host;
            document.getElementById('ws_port').value = c.server.ws_port;
            document.getElementById('heartbeat_interval').value = c.server.heartbeat_interval;
            document.getElementById('shutdown_timeout').value = c.server.shutdown_timeout;

            // Database
            document.getElementById('db_driver').value = c.database.driver;
            document.getElementById('sqlite_path').value = c.database.sqlite.path;
            document.getElementById('pg_host').value = c.database.postgres.host;
            document.getElementById('pg_port').value = c.database.postgres.port;
            document.getElementById('pg_username').value = c.database.postgres.username;
            document.getElementById('pg_password').value = c.database.postgres.password;
            document.getElementById('pg_database').value = c.database.postgres.database;
            toggleDbFields();
            updateConnUrl();

            // Security
            document.getElementById('jwt_secret').value = c.security.jwt_secret;
            document.getElementById('jwt_expiration_hours').value = c.security.jwt_expiration_hours;

            // Admin
            document.getElementById('admin_username').value = c.admin.username;
            document.getElementById('admin_email').value = c.admin.email;
            document.getElementById('admin_password').value = c.admin.password;

            // Logging
            document.getElementById('log_level').value = c.logging.level;
        }

        function gatherForm() {
            return {
                server: {
                    api_host: document.getElementById('api_host').value,
                    api_port: parseInt(document.getElementById('api_port').value) || 8080,
                    ws_host: document.getElementById('ws_host').value,
                    ws_port: parseInt(document.getElementById('ws_port').value) || 9000,
                    heartbeat_interval: parseInt(document.getElementById('heartbeat_interval').value) || 300,
                    shutdown_timeout: parseInt(document.getElementById('shutdown_timeout').value) || 30,
                },
                database: {
                    driver: document.getElementById('db_driver').value,
                    sqlite: {
                        path: document.getElementById('sqlite_path').value,
                    },
                    postgres: {
                        host: document.getElementById('pg_host').value,
                        port: parseInt(document.getElementById('pg_port').value) || 5432,
                        username: document.getElementById('pg_username').value,
                        password: document.getElementById('pg_password').value,
                        database: document.getElementById('pg_database').value,
                    },
                },
                security: {
                    jwt_secret: document.getElementById('jwt_secret').value,
                    jwt_expiration_hours: parseInt(document.getElementById('jwt_expiration_hours').value) || 24,
                },
                admin: {
                    username: document.getElementById('admin_username').value,
                    email: document.getElementById('admin_email').value,
                    password: document.getElementById('admin_password').value,
                },
                logging: {
                    level: document.getElementById('log_level').value,
                },
            };
        }

        async function saveConfig() {
            try {
                const cfg = gatherForm();
                await invoke('save_config', { config: cfg });
                showToast('âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾! ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ÑĞµÑ€Ğ²ĞµÑ€ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ.');
            } catch (e) {
                showToast('âŒ ' + e, true);
            }
        }

        async function saveAndRestart() {
            try {
                const cfg = gatherForm();
                showToast('ğŸ”„ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº...');
                await invoke('save_and_restart', { config: cfg });
                showToast('âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ñ‹, ÑĞµÑ€Ğ²ĞµÑ€ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!');
            } catch (e) {
                showToast('âŒ ' + e, true);
            }
            setTimeout(updateStatus, 1000);
        }

        async function resetConfig() {
            await loadConfig();
            showToast('ğŸ”„ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ñ‹');
        }

        function toggleDbFields() {
            const driver = document.getElementById('db_driver').value;
            document.getElementById('sqlite_fields').style.display = driver === 'sqlite' ? '' : 'none';
            document.getElementById('postgres_fields').style.display = driver === 'postgres' ? '' : 'none';
            updateConnUrl();
        }

        function updateConnUrl() {
            const driver = document.getElementById('db_driver').value;
            let url;
            if (driver === 'sqlite') {
                url = 'sqlite://' + (document.getElementById('sqlite_path').value || './ocpp.db') + '?mode=rwc';
            } else {
                const h = document.getElementById('pg_host').value || 'localhost';
                const p = document.getElementById('pg_port').value || '5432';
                const u = document.getElementById('pg_username').value || 'ocpp';
                const d = document.getElementById('pg_database').value || 'ocpp';
                url = `postgres://${u}:***@${h}:${p}/${d}`;
            }
            document.getElementById('connUrl').textContent = 'ğŸ”— ' + url;
        }

        // Update connection URL on input changes
        ['db_driver', 'sqlite_path', 'pg_host', 'pg_port', 'pg_username', 'pg_database'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', updateConnUrl);
        });

        // Init
        loadConfig();
        updateStatus();
    </script>
</body>
</html>
